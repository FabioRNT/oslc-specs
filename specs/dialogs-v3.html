<!DOCTYPE html>
<html>
<head>
<meta charset='utf-8'/>
<script src='https://sspeiche.github.io/respec/builds/oasis/respec-oasis-common.js' async class='remove'></script>
<script class='remove'>
  var respecConfig = {
      specStatus:           "WD",
      edDraftURI:           "http://tools.oasis-open.org/version-control/browse/wsvn/oslc-core/specs/dialogs-v3.html",

      // the specification's short name, as in http://www.w3.org/TR/short-name/
      shortName:            "OSLC Delegated Dialogs 3.0",

      // if your specification has a subtitle that goes below the main
      // formal title, define it here
      // subtitle   :  "an excellent document",

      // if you wish the publication date to be other than the last modification, set this
      // publishDate:  "2009-08-06",

      // if the specification's copyright date is a range of years, specify
      // the start date here:
      // copyrightStart: "2005"

      // if there is a previously published draft, uncomment this and set its YYYY-MM-DD date
      // and its maturity status
      // previousPublishDate:  "1977-03-15",
      // previousMaturity:  "WD",

      // if there a publicly available Editor's Draft, this is the link
      // edDraftURI:           "http://berjon.com/",

      // if this is a LCWD, uncomment and set the end of its review period
      // lcEnd: "2009-08-05",

      // editors, add as many as you like
      // only "name" is required
      editors:  [
          {
              name:       "Samuel Padgett"
          ,   mailto:     "spadgett@us.ibm.com"
          ,   company:    "IBM"
          ,   companyURL: "http://ibm.com/"
          },
          {
              name:       "Steve Speicher"
          ,   url:        "http://stevespeicher.me/"
          ,   mailto:     "sspeiche@us.ibm.com"
          ,   company:    "IBM"
          ,   companyURL: "http://ibm.com/"
          }
      ],

      maxTocLevel: 2,

      // previousURI: "http://open-services.net/bin/view/Main/OslcCoreUiPreview",
      prevED: "http://open-services.net/bin/view/Main/OslcCoreSpecification#Delegated_User_Interface_Dialogs",

      // name of the WG
      wg:           "OASIS OSLC Lifecycle Integration Core (OSLC Core) TC",

      // URI of the public WG page
      wgURI:        "https://www.oasis-open.org/apps/org/workgroup/oslc-core/",

      // name (without the @w3c.org) of the public mailing to which comments are due
      wgPublicList: "oslc-core",

      // URI of the patent status for this WG, for Rec-track documents
      // !!!! IMPORTANT !!!!
      // This is important for Rec-track documents, do not copy a patent URI from a random
      // document unless you know what you're doing. If in doubt ask your friendly neighbourhood
      // Team Contact.
      wgPatentURI:  "",
      // !!!! IMPORTANT !!!! MAKE THE ABOVE BLINK IN YOUR HEAD

      localBiblio:  {
          "OSLCPreview30": {
              title:    "OSLC Resource Preview 3.0",
              href:     "http://tools.oasis-open.org/version-control/browse/wsvn/oslc-core/specs/resource-preview.html",
              authors:  [ "S. Padgett", "S. Speicher" ],
              status:   "Working Draft",
              publisher:  "https://www.oasis-open.org/"
          }
      }
  };
</script>
<title>OSLC Delegated Dialogs 3.0</title>
<style type="text/css">
    table, thead, tr, td {
        padding: 5px;
        border-width: 1px;
        border-spacing: 0px;
        border-style: solid;
        border-collapse: collapse;
    }

    td {
        min-width: 100px;
    }

    .conformance section {
        margin-top: 1.33em;
        margin-bottom: 1.33em;
    }

    .conformance h4 {
        color: black;
        font-family: inherit;
        font-size: 100%;
        font-weight: normal;
        display: inline;
    }

    code {
        font-weight:bold;
    }

    .rfc2119 {
        font-weight:bold;
    }

    dd {
        padding-top: 5px;
        padding-bottom: 10px;
    }
</style>
</head>

<body>
<section id="abstract">
  <p>Delegated dialogs allow one application to embed a creation or selection
      UI into another using HTML iframe elements and JavaScript code.</p>
</section>

<section id="toc"></section>
<hr>

<section id="introduction">
    <h2>Introduction</h2>

    <p>OSLC specifications target specific integration scenarios. In some cases,
        allowing one product to delegate to a user interface defined in another
        product is a more effective way to support a use case than an HTTP
        interface that can only be accessed programmatically. There are two cases
        where this is especially true:</p>

    <ul>
        <li><em>Resource creation</em>: when a user of a web application needs
            to create a new resource in another application. In this case, the
            web application asks the other server to provide a UI for resource
            creation, and the server notifies the application when the creation has
            been completed or canceled by the user.</li>

        <li><em>Resource selection</em>: when a user of a web application and
            needs to pick a resource managed by another application. In this
            case, the web application asks the other server to provide a UI for
            resource selection, and the server notifies the application when a
            resource or resources has been selected or if the selection was
            canceled.</li>
    </ul>

    <p>Delegated dialogs support these two cases.  They allow one application to
        embed a creation or selection UI into another using HTML iframe elements
        and JavaScript code. The diagram below illustrates how delegated dialogs
        work in a scenario where Provider A wants to allow a user to select or
        create a resource managed by Provider B.</p>
   <figure>
      <img src="oslc-delegated.png" />
      <figcaption>Delegated UI Dialogs</figcaption>
   </figure>

   <div class="note">Diagram is out of date.</dev>
</section>

<section id="sotd"></section>

<section id='conformance'></section>

<section class="glossary" id="terminology">
    <h2>Terminology</h2>

    <p>This document uses terms as defined below.</p>

    <dl>
        <dt class="loc-heading">Delegated Dialog</dt>
        <dd>A web page for creating or selecting resources to be embedded
            inside another application.</dd>

        <dt class="loc-heading">Prefill</dt>
        <dd>A method of populating initial field values in a creation
            dialog.</dd>

        <dt class="loc-heading">Client</dt>
        <dd>An application that embeds a delegated dialog from another
            application. A client could be a web page or a native application
            that is embedding a web browser component.</dd>

        <dt class="loc-heading">Server</dt>
        <dd>An application that offers one or more delegated dialogs.</dd>
    </dl>
</section>

<section class="informative" id="discovery">
    <h2>Discovering Dialogs</h2>

    See <a href="https://tools.oasis-open.org/version-control/browse/wsvn/oslc-core/specs/discovery.html?sc=1#dialogs">Discovery 3.0</a>. (To be moved into this document.)</div>
</section>

<section class="informative" id="examples">
<h2>Using Dialogs</h2>

  <p>Servers can offer two kinds of dialogs, selection dialogs and creation
      dialogs. Clients use selection dialogs when they want a user to pick a
      resource from another application. They use creation dialogs when they
      want a user to create a new resource in another application.</p>

    <p>A client shows a dialog in an HTML page by creating an
        <code>iframe</code> element and setting the <code>src</code> attribute
        to the URI of the dialog to be included.</p>

<pre class="example highlight" title="Display a Dialog">
    var iframe = document.createElement("iframe");
    iframe.seamless = "true";
    iframe.style.width = "600px";  // or preferred dialog width
    iframe.style.height = "400px"; // or preferred dialog height
    iframe.src = "http://example.com/bugs/dialog";
    document.getElementById("dialogContainer").appendChild(iframe);
</pre>

  <p>Dialogs send results back to the client using the HTML5 function
      <code>window.postMessage</code> [[webmessaging]]. Typically, the embedded
      page will be loaded in an <code>iframe</code> inside some surrounding web
      page. In such cases, <code>postMessage</code> is called on that parent
      window. In a native application, an outer page is not needed and the
      embedded page may be shown directly in the browser's "root" window. When
      the embedded page has no parent window, it calls <code>postMessage</code>
      on its own window.</p>

  <section id="client_responsibilities">
  <h3>The Client's Responsibilities</h3>

  <ol>
      <li>Include the dialog via an <code>iframe</code>, setting
          <code>iframe</code> <code>src</code> to the URI of the dialog, or via
          an embedded browser.</li>

    <li>Add a <code>message</code> listener to the outer window to receive
        messages from the dialog.</li>

    <li>Listen for window <code>message</code> events, ignoring unrecognized
        events from other sources or those not prefixed with
        <code>oslc-response:</code></li>

    <li>When message from the dialog indicates a completed action, free
        resources and handle the action.</li>
  </ol>

<pre class="example highlight" title="Listen for Dialog Results">
    window.addEventListener("message", function(event) {
        // Make sure the message originated from example.com.
        if (event.origin !== "http://example.com") {
            return;
        }

        // Make sure the message starts with oslc-response:
        var message = event.data;
        if (message.indexOf("oslc-response:") !== 0) {
            return;
        }

        // Handle each result.
        var response = JSON.parse(message.substr("oslc-response:".length));
        var results = response["oslc:results"];
        for (var i = 0; i < results.length; i++) {
            var label = results[i]["oslc:label"];
            var uri = results[i]["rdf:resource"];
            // Handle resource...
        }

        // Remove the dialog from the page.
        var dialogContainer = document.getElementById('dialogContainer');
        dialogContainer.removeChild(dialogContainer.firstChild);
    }, false);
</pre>

</section>
<section id="server_responsibilities">
  <h3>The Server's Responsibilities</h3>

  <ol>
    <li>Provide the dialog, an HTML page for resource creation or
        selection.</li>

    <li>Allow the user to perform resource creation or selection.</li>

    <li>Once the user has created, selected, or canceled, send notification
        using <code>postMessage</code> to the page's parent window, passed in
        <code>event.data</code> string, that is prefixed with
        <code>"oslc-response:"</code>.</li>

    <li>If the page is not parented, then the message is posted to the page's
        own window. The page must ignore this message to itself.</li>
  </ol>

  <p>The following JavaScript code example shows how a dialog would send
      a response using <code>postMessage</code>, taking into account
      pages that are not parented.</p>

<pre class="example highlight" id="ex_post_message">
    function respondWithSelection(label, uri) {
        var response = {
            "oslc:results": [ {
                "oslc:label": label,
                "rdf:resource": uri
            } ]
        };
        (window.parent || window).postMessage("oslc-response:" + JSON.stringify(response), "*");
    }
</pre>
</section>

<section class="informative" id="prefill">
  <h2>Prefilling Creation Dialogs</h2>

  <p>Servers may support setting the initial values in a creation dialog. A
      client can test if a dialog supports prefill using HTTP OPTIONS.</p>

<pre class="example" id="ex_options_dialog">
HEAD /bugs/dialog HTTP/1.1
Host: example.com
</pre>

  <p>If the server supports prefill for this dialog, it includes POST among the
      methods in the <code>Allow</code> response header.</p>

<pre class="example" id="ex_options_response">
HTTP/1.1 204 No Content
Allow: GET,POST,HEAD,OPTIONS
</pre>

<p>To prefill content, clients POST the resource representation with the
    desired initial values. The actual content depends on the type of resource
    and the server.</p>

<div class="note">
We might discuss resource shapes or Link rel="describedby"
</div>

<pre class="example" id="ex_prefill_request">
POST /bugs/dialog HTTP/1.1
Host: example.com
Content-Type: text/turtle
Content-Length: nnn

@prefix oslc_cm: &lt;http://open-services.net/ns/cm#&gt; .
@prefix dcterms: &lt;http://purl.org/dc/terms/&gt; .

&lt;&gt;
   a oslc_cm:Bug ;
   dcterms:title "Build 23 failed" ;
   oslc_cm:severity &lt;http://example.com/enums#S1&gt; .
</pre>

The server's response contains a <code>Location</code> header with the
prefilled dialog's URI. The client uses this as the <code>iframe src</code>.

<pre class="example" id="ex_prefill_response">
HTTP/1.1 201 Created
Location: http://example.com/bugs/dialog/2zFy45
</pre>

<p>The dialog URI is often temporary. After a reasonable time, the server might
    respond with 404 Not Found or 410 Gone.</p>

</section>
</section>

<!-- Conformance clauses have empty <h2></h2> tags for ReSpec to generate
     section numbers. -->
<section id="implementation_conformance" class="conformance">
    <h2>Implementation Conformance</h2>

    <section id="discovery_conformance">
        <h2>Discovery</h2>

        TBD
    </section>

    <section id="display_conformance">
        <h2>Display</h2>

        <section id="postmessage_parent_window">
            <h2></h2>

            When presenting a dialog inside another web application, the client
            MUST use an <code>iframe</code> element and set the its
            <code>src</code> attribute to the URI of the dialog.
        </section>
    </section>

    <section id="messaging_conformance">
        <h2>Messaging</h2>

        <section id="postmessage_parent_window">
            <h2></h2>

            Dialogs MUST send their results to clients using the
            <code>window.postMessage</code> method [[!webmessaging]].
        </section>
        <section id="message_contents">
            <h2></h2>

            Messages describing dialog results MUST start with the characters
            <code>oslc-response:</code> followed by JSON as specified in
            <a href="#results_json"></a>.

<pre class="example" id="ex_results_message">
    oslc-response:{"oslc:results": [{ "oslc:label": "Bug 123: Server crash", "rdf:resource": "http://example.com/bug123" }]}
</pre>
        </section>
        <section id="results_other_props">
            <h2></h2>

            Servers MAY include additional server-specific properties in the
            results JSON.
        </section>
        <section id="postmessage_canceled">
            <h2></h2>

            If the user cancels a dialog, the dialog MUST still send a message
            with an empty <code>oslc:results</code> array.

<pre class="example" id="ex_results_message">
    oslc-response:{"oslc:results": []}
</pre>
        </section>
        <section id="postmessage_parent_window">
            <h2></h2>

            Calls to <code>postMessage</code> from within a dialog MUST be made
            on <code>window.parent</code> unless <code>null</code> or
            <code>undefined</code>.
        </section>
        <section id="postmessage_own_window">
            <h2></h2>

            If <code>window.parent</code> is <code>null</code> or
            <code>undefined</code>, calls to <code>postMessage</code> MUST be
            made on the dialog's own window, allowing rich client applications
            to handle the event. The page MUST ignore this <code>message</code>
            to itself.

<pre class="example highlight" id="ex_postMessage">
function respondWithPostMessage(response) {
    (window.parent || window).postMessage("oslc-response:" + response, "*");
}
</pre>
        </section>
        <section id="message_origin">
            <h2></h2>

            Clients handling <code>message</code> events from dialogs MUST
            verify that the event <code>origin</code> is the same as the
            dialog.

            <p>For example, if the dialog is from example.com,

<pre class="example highlight" id="ex_verify_origin">
function handleMessage(event) {
    if (event.origin !== "http://example.com") {
        return;
    }

    // Otherwise, process message...
}
</pre></p>
        </section>
        <section id="resize">
            <h2></h2>

            Dialogs MAY support dynamic resizing as specified in
            [[!OSLCPreview30]].
        </section>
        <section id="ignore_unrecognized_messages">
            <h2></h2>

            Clients MUST anticipate other, unrelated uses of
            <code>postMessage</code> and ignore unrecognized messages not
            conforming to the protocol.
        </section>
    </section>
    <section id="prefill_conformance">
        <h2>Prefill</h2>
        <section id="allow_prefill">
            <h2></h2>

            Servers MAY allow clients to prefill creation dialogs by sending a
            POST request to the dialog URI where the entity body is a
            resource representation describing the initial values.
        </section>
        <section id="dialog_options">
            <h2></h2>

            Servers that support prefill SHOULD include the value
            <code>POST</code> in the set of <code>Allow</code> header values
            returned in response to HTTP OPTIONS requests for the dialog URI.

<pre class="example" id="ex_verify_origin">
Allow: GET,POST,HEAD,OPTIONS
</pre>
        </section>
        <section id="partial_prefill">
            <h2></h2>

            Servers MUST NOT reject dialog prefill requests solely because they
            are missing required fields for the resource. Users can fill in the
            missing values in the dialog.
        </section>
        <section id="prefill_response">
            <h2></h2>

            On successful prefill requests, servers MUST respond with status
            code 201 (Created) and a <code>Location</code> header whose value
            is the URI of the prefilled dialog.
        </section>
        <section id="prefill_temp_uris">
            <h2></h2>

            After some elapsed time, servers MAY respond with a 404 (Not Found)
            or 410 (Gone) to an HTTP GET request for a prefilled dialog URI.
            Clients SHOULD NOT cache dialog URIs from prefill requests since
            they are often temporary.
        </section>
    </section>
</section>

<section class="appendix" id="results_json">
    <h2>Dialog Results JSON</h2>
    <p>Dialog results are represented as JSON [[!RFC4627]], prefixed with the
        characters <code>oslc-response:</code> when sent as a message in calls
        to <code>postMessage</code>. The top-level JSON object has an
        <code>oslc:results</code> property.</p>

    <table style="width: 100%">
        <colgroup>
            <col span="1" style="width: 18%;">
            <col span="1" style="width: 18%;">
            <col span="1" style="width: 18%;">
            <col span="1" style="width: 46%;">
        </colgroup>
        <thead>
            <tr>
                <th>Property</th>
                <th>Type</th>
                <th>Occurs</th>
                <th>Description</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><code>oslc:results</code></td>
                <td>JSON Array</td>
                <td>Exactly-one</td>
                <td>An array of zero or more results, each result a JSON
                    object. An empty array means the user canceled the dialog
                    or didn't select a resource.</td>
            </tr>
        </tbody>
    </table>

    <p>Each result is a JSON object with the following properties.</p>

    <table style="width: 100%">
        <colgroup>
            <col span="1" style="width: 18%;">
            <col span="1" style="width: 18%;">
            <col span="1" style="width: 18%;">
            <col span="1" style="width: 46%;">
        </colgroup>
        <thead>
            <tr>
                <th>Property</th>
                <th>Type</th>
                <th>Occurs</th>
                <th>Description</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><code>rdf:resource</code></td>
                <td>String</td>
                <td>Exactly-one</td>
                <td>URI of the resource selected or created</td>
            </tr>
            <tr>
                <td><code>oslc:label</code></td>
                <td>String</td>
                <td>Zero-or-one</td>
                <td>Short label describing the resource selected</td>
            </tr>
        </tbody>
    </table>

<pre class="example highlight" id="ex_creation_message">
{
    "oslc:results": [
        {
            "oslc:label": "Bug 123: Server crash",
            "rdf:resource": "http://example.com/bug123"
        },
        {
            "oslc:label": "Bug 456: Client hangs on startup",
            "rdf:resource": "http://example.com/bug456"
        }
    ]
}
</pre>
</section>

<section class="appendix informative" id="history">
<h2>Change History</h2>
<p>Below is a summary of some of the changes in this draft</p>

<ul>
    <li>2015-02-03 Move conformance clauses to numbered sections. Remove
        windowName protocol. Refer to dynamic resizing in Resource Preview 3.0.
        (SP)</li>
    <li>2014-12-04 Shorten spec title. (SP)</li>
    <li>2014-08-28 Add Change History and References. (SP)</li>
    <li>2014-08-27 Initial draft, contributed from open-services.net. (SP)</li>
</ul>
</section>

</body>
</html>

