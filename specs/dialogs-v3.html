<!DOCTYPE html>
<html>
<head>
<meta charset='utf-8'/>
<script src='https://sspeiche.github.io/respec/builds/oasis/respec-oasis-common.js' async class='remove'></script>
<script class='remove'>
  var respecConfig = {
      specStatus:           "CS",
      edDraftURI:           "dialogs.html",

      // the specification's short name, as in http://www.w3.org/TR/short-name/
      shortName:            "OSLC 3.0 Delegated Dialogs",

      // if your specification has a subtitle that goes below the main
      // formal title, define it here
      // subtitle   :  "an excellent document",

      // if you wish the publication date to be other than the last modification, set this
      // publishDate:  "2009-08-06",

      // if the specification's copyright date is a range of years, specify
      // the start date here:
      // copyrightStart: "2005"

      // if there is a previously published draft, uncomment this and set its YYYY-MM-DD date
      // and its maturity status
      // previousPublishDate:  "1977-03-15",
      // previousMaturity:  "WD",

      // if there a publicly available Editor's Draft, this is the link
      // edDraftURI:           "http://berjon.com/",

      // if this is a LCWD, uncomment and set the end of its review period
      // lcEnd: "2009-08-05",

      // editors, add as many as you like
      // only "name" is required
      editors:  [
          {
              name:       "Samuel Padgett"
          ,   mailto:     "spadgett@us.ibm.com"
          ,   company:    "IBM"
          ,   companyURL: "http://ibm.com/"
          },
          {
              name:       "Steve Speicher"
          ,   url:        "http://stevespeicher.me/"
          ,   mailto:     "sspeiche@us.ibm.com"
          ,   company:    "IBM"
          ,   companyURL: "http://ibm.com/"
          }
      ],

      // previousURI: "http://open-services.net/bin/view/Main/OslcCoreUiPreview",
      prevED: "http://open-services.net/bin/view/Main/OslcCoreSpecification#Delegated_User_Interface_Dialogs",

      // name of the WG
      wg:           "OASIS OSLC Lifecycle Integration Core (OSLC Core) TC",

      // URI of the public WG page
      wgURI:        "https://www.oasis-open.org/apps/org/workgroup/oslc-core/",

      // name (without the @w3c.org) of the public mailing to which comments are due
      wgPublicList: "oslc-core",

      // URI of the patent status for this WG, for Rec-track documents
      // !!!! IMPORTANT !!!!
      // This is important for Rec-track documents, do not copy a patent URI from a random
      // document unless you know what you're doing. If in doubt ask your friendly neighbourhood
      // Team Contact.
      wgPatentURI:  "",
      // !!!! IMPORTANT !!!! MAKE THE ABOVE BLINK IN YOUR HEAD
  };
</script>
<title>Open Services for Lifecycle Collaboration Delegated Dialogs Specification 3.0</title>
<style type="text/css">
table, thead, tr, td {
padding: 5px;
border-width: 1px;
border-spacing: 0px;
border-style: solid;
border-collapse: collapse;
}

td {
min-width: 100px;
}
</style>
</head>

<body>
<section id="abstract">
  <p>This document outlines a technique that can be used to show a user
      in-context information when displaying a link to a resource and then show
      more detailed preview when the user gestures.</p>
</section>

<section id="sotd">Early Working Draft</section>

<section id="introduction">
  <h2>Introduction</h2>

  <p>OSLC specifications target specific integration scenarios. In some cases,
      allowing one product to delegate to a user interface defined in another
      product is a more effective way to support a use case than an HTTP
      interface that can only be accessed programmatically. There are two cases
      where this is especially true:</p>

  <ul>
      <li><em>Resource creation</em>: when a user of a web application needs
          to create a new resource in an OSLC Service Provider. In this case the
          web application asks the service provider to provide a UI for resource
          creation and the provider notifies the application when the creation has
          been completed or canceled by the user.</li>

      <li><em>Resource selection</em>: when a user of a web application and needs
          to pick a resource managed by a OSLC Service Provider. In this case the
          web application asks the service provider to provide a UI for resource
          selection and the provider notifies the application when a resource or
          resources has been selected or if the selection was canceled.</li>
  </ul>

  <p>To support these two cases, below we define OSLC Delegated User Interface
      (UI) Dialogs. Delegated UI Dialogs are a technique where one provider can
      embed a creation or selection UI into another using a combination of an
      HTML iframe and JavaScript code. The diagram below illustrates how
      delegated UI dialogs work in a scenario where Provider A wants to allow a
      user to select or create a resource managed by Provider B.</p>

  <figure>
     <img src="oslc-delegated.png" />
     <figcaption>Delegated UI Dialogs</figcaption>
  </figure>

</section>

<section class="glossary" id="terminology">
  <h2>Terminology</h2>

  <p>The following terms are used in discussions of Delegated UI Dialogs:</p>

  <dl>
    <dt>UI Consumer</dt>
    <dd>A web application that is embedding a Delegated UI Dialog from an OSLC
        Service Provider. This consumer could be a web page, with the Delegated
        UI Dialog loaded into an iframe or a native application, e.g. an IDE
        like Eclipse, that is embedding a web browser component.</dd>

    <dt>UI Provider</dt>
    <dd>An OSLC Service provider that offers one or more Delegated UI Dialogs.
        These dialogs will be specified in the provider's Service Provider
        resource.</dd>
  </dl>
</section>

<section class="informative" id="protocols">
  <h2>Post Message and Window Name protocols</h2>

  <p>To support the widest range of web browsers, we define two different
      protocols for communicating the information about the user's action from
      the UI Provider and back to the UI Consumer. These are the Post Message
      and Window Name protocols described below.</p>

  <p>In both the Post Message and Window Name protocols, the way that a UI
      Consumer includes a Delegated UI Dialog in an HTML page is to create an
      <code>iframe</code> and specify the <code>src</code> as the URI of the
      Delegated UI Dialog to be included. The UI Consumer indicates the
      protocol to be used by appending one of the two fragment identifiers
      below to the URI:</p>

  <ul>
    <li><code>#oslc-core-postMessage-1.0</code> - Indicates that the Post
        Message protocol is to be used</li>

    <li><code>#oslc-core-windowName-1.0</code> - Indicates that the Window Name
        protocol is to be used</li>
  </ul>

  <p>The JavaScript code example below shows now a UI Provider can determine
      which protocol is in use:</p>

<pre class="example" id="determineProtocol">
if (window.location.hash == '#oslc-core-windowName-1.0') {
   // Window Name protocol in use
} else if (window.location.hash == '#oslc-core-postMessage-1.0') {
   // Post Message protocol in use
}
</pre>
</section>

<section class="informative" id="creatingiframes">
  <h2>iframe Creation Considerations</h2>

  <p>Regardless of the protocol in effect, it is recommended that UI Consumers
      follow the below iframe creation guidelines to provide a more seamless
      user experience:</p>

  <ul>
    <li>Embed the <code>iframe</code> within a <code>div</code> element, with
        height and width set based on the length values specified in
        the Service Resource that declares the Delegated UI Dialog.</li>

    <li>Set the <code>iframe</code> border size to '0'</li>

    <li>Set the <code>iframe</code> scrolling to 'auto'</li>
  </ul>
</section>

<section id="postMessage">
  <h2>Post Message Protocol</h2>

  <p>The Post Message protocol relies on the HTML5 function
      <code>window.postMessage()</code> [[webmessaging]], available in the
      latest or pending releases of most browsers. UI Consumers
      <strong>MUST</strong> anticipate other, unrelated uses of
      <code>postMessage()</code> and ignore messages not conforming to this
      protocol.</p>

  <p>Typically, the embedded page will be loaded in a window inside another
      window, such as a iframe inside some surrounding web page. In such cases,
      <code>postMessage()</code> <strong>MUST</strong> be called on that parent
      window. But in a native application, an outer page is not needed and the
      embedded page may be shown directly in the browser's "root" window. When
      the embedded page has no parent window, it must call
      <code>postMessage()</code> on its own window.</p>

  <p>Here are the responsibilities of the UI Consumer and UI Provider in Post Message
      protocol.</p>

  <h3>The UI Consumer's responsibilities</h3>

  <ol>
    <li>Include the Delegated UI Dialog via iframe (i.e., setting iframe src to
        the URI of the Delegated UI Dialog) or via an embedded browser. Append
        the fragment identifier <code>#oslc-core-postMessage-1.0</code> to the
        URL to indicate that Post Message is the desired protocol.</li>

    <li>Add a <code>'message'</code> listener to the outer window to receive
        messages from the Delegated UI Dialog.</li>

    <li>Listen for window <code>'message'</code> events, ignoring events from
        other sources or not prefixed with <code>"oslc-response:"</code></li>

    <li>When message from Delegated UI Dialog indicates user completed action,
        free resources and handle action.</li>
  </ol>

  <h3>The UI Provider's responsibilities</h3>

  <ol>
    <li>Provide Delegated UI Dialog, an HTML page that provides a user
        interface for resource creation or selection.</li>

    <li>Allow the user to perform resource creation or selection.</li>

    <li>Once the user has created, selected or canceled, send notification
        using <code>postMessage()</code> to the page's parent window, passed in
        <code>event.data</code> string, that is prefixed with
        <code>"oslc-response:"</code> See below for the two possible response
        formats, one for resource selection and one for creation.</li>

    <li>If the page is not parented, then the message is posted to the page's
        own window.  The page <strong>MUST</strong> ignore this message to
        itself.</li>
  </ol>

  <p>The below JavaScript code example shows how a UI Provider page would send
      a response using <code>postMessage()</code> and taking into account the
      fact that some pages are not parented.</p>

<pre class="example" id="respondWithPostMessage">
function respondWithPostMessage(/*string*/ response) {
    (window.parent || window).postMessage("oslc-response:" + response, "*");
}
</pre>

</section>


<section id="windowName">
  <h2>Window Name Protocol</h2>

  <p>The Window Name protocol uses the HTML DOM <code>window.name</code>
      property to communicate the response (reference: Window Object) from the
      UI Provider to the UI Consumer. This special property of window maintains
      its value even as the window navigates to a different origin, but the
      ifame's <code>window.name</code> can only be read when the accessing
      window shares the same origin. For this to happen, when the embedded page
      is finished it must set the <code>window.name</code> and also change the
      <code>window.location</code> to a page with the same origin as the outer
      frame. This not only allows the UI Consumer to access the result, but
      also fires an event telling the UI Consumer when to do so. This return
      location is passed to the embedded page using the
      <code>window.name</code> property.</p>

  <p>Here are the responsibilities of the UI Consumer and UI Provider in Window Name
  protocol.</p>

  <h3>The UI Consumer's responsibilities</h3>

  <ol>
    <li>Include the Delegated UI Dialog via iframe (i.e setting iframe src to
        the URI of the Delegated UI Dialog) or via an embedded browser. Append
        the fragment identifier <code>#oslc-core-windowName-1.0</code> to the
        URL to indicate that Window Name is the desired protocol.</li>

    <li>On the iframe, set the frame's <code>window.name</code> to
    indicate the Return URL.</li>

    <li>On the iframe, Listen for <code>onload</code> events</li>

    <li>When an <code>onload</code> event occurs and the frame's location is
        equal to the Return URL then read the response from the
        window.name.</li>
  </ol>

  <p>The following Javascript code illustrates the protocol. The code for the
      <code>destroyFrame()</code>, <code>handleMessage()</code> and
      <code>displayFrame()</code> methods are not provided in this example, but
      should be obvious to a JavaScript developer. The UI Consumer must provide
      these methods.</p>

<pre class="example" id="consumeWindowName">
var pickerURL = ... // URL of Provider's Delegated UI Dialog
var returnURL = ... // Consumer's Return URL

var frame = document.createElement('iframe');

function windowNameProtocol() {

    // Step #1: create iframe with fragment to indicate protocol
    // Step #2: set the iframe's window.name to indicate the Return URL
    if (ie &gt; 0) {
        frame = document.createElement('&lt;iframe name=\'' + returnURL + '\'&gt;');
    } else {
        frame = document.createElement('iframe');
        frame.name = returnURL;
    }
    frame.src = pickerURL + '#oslc-core-windowName-1.0';
    frame.width = 450;
    frame.height = 300;

    displayFrame(frame);

    // Step #3: listen for onload events on the iframe
    var ie = window.navigator.userAgent.indexOf("MSIE");
    if (ie &gt; 0) {
        frame.attachEvent("onLoad", onFrameLoaded);
    } else {
        frame.onload = onFrameLoaded;
    }
}

function onFrameLoaded() {
    try { // May throw an exception if the frame's location is still a different origin

        // Step #4: when frame's location is equal to the Return URL
        // then read response and return.
        if (frame.contentWindow.location == returnURL) {
            var message = frame.contentWindow.name;
            destroyFrame(frame);
            handleMessage(message);
        }

    } catch (e) {
        // ignore: access exception when trying to access window name
    }
}
</pre>

  <h3>The UI Provider's responsibilities</h3>

  <p>As soon as the embedded page has loaded, perform the following:</p>

  <ol>
    <li>Provide Delegated UI Dialog, an HTML page that provides a user
        interface for resource creation or selection.</li>

    <li>Read the Return URL from the window.name variable</li>

    <li>Allow user to perform resource creation or selection.</li>

    <li>Once user has created, selected or canceled, communicate the user's
        response by setting the window.name variable to the response. See below
        for the two possible response formats, one for resource selection and
        one for creation.</li>

    <li>Indicate that user has responded by setting the window.location to the
        Return URL specified by the UI Consumer.</li>
  </ol>

  <p>The JavaScript example below shows a UI Provider notifying its UI Consumer
      after a user has responded.</p>

<pre class="example" id="respondWithWindowName">
function respondWithWindowName(/*string*/ response) {
    // Step #2: read the return URL
    var returnURL = window.name;

    // Step #4: send the response via the window.name variable
    window.name = response;

    // Step #5: indicate that user has responded
    window.location = returnURL;
}
</pre>

  <h3>Resource Selection</h3>

  <p>Resource Selection can be used when a UI Consumer wants to allow a user to
      pick a resource that is managed by an OSLC Service. Using either the Post
      Message or Window Name protocols defined above, the UI Consumer uses an
      iframe to embed a selection dialog that is provided by the service, then
      awaits notification that the user has selected a resource.</p>

  <p>To enable Resource Selection, an OSLC Service <em>MUST</em> provide in its
      Service Resource a value for the <code>oslc:selectionDialog</code>
      property. The property value will include a <code>oslc:dialogURI</code>
      property that indicates the URI of the selection dialog.</p>

  <p>Regardless of how the response from the UI Provider is conveyed to the UI
      Consumer, the response <em>SHOULD</em> be formatted as follows:</p>

  <ul>
    <li><em>Name:</em> <code>results</code></li>

    <li>
      <p><em>URI:</em>
          <a href= "http://open-services.net/ns/core#results">http://open-services.net/ns/core#results</a></p>
    </li>
  </ul>

  <table>
      <thead>
          <tr>
              <th>JSON Property Name</th>
              <th>Type</th>
              <th>Occurs</th>
              <th>Description</th>
          </tr>
      </thead>

      <tbody>
          <tr>
              <td><code>rdf:resource</code></td>
              <td>String</td>
              <td>zero-or-one</td>
              <td>URI of the resource selected or created</td>
          </tr>
          <tr>
              <td><code>oslc:label</code></td>
              <td>String</td>
              <td>zero-or-one</td>
              <td>Short label describing the resource selected</td>
          </tr>
      </tbody>
  </table>

  <p>An empty array indicates that the resource selector has been canceled.</p>

  <p>An example Resource Selection response:</p>

<pre class="example" id="oslcResultsSelection">
{
    "oslc:results": [
        {
            "oslc:label": "Bug 123: Server crash",
            "rdf:resource": "http://example.com/bug123"
        },
        {
            "oslc:label": "Bug 456: Client hangs on startup",
            "rdf:resource": "http://example.com/bug456"
        }
    ]
}
</pre>

  <h3>Resource Creation</h3>

  <p>Resource Creation can be used when a UI Consumer wants to allow a user to
      create a new resource that is managed by an OSLC Service. Using either
      the Post Message or Window Name protocols defined above, the UI Consumer
      uses an iframe to embed a creation dialog that is provided by the
      service, then awaits notification that the user has created a
      resource.</p>

  <p>To enable Resource Creation, an OSLC Service <em>MUST</em> provide in its
      Service Resource a value for the <code>oslc:creationDialog</code>
      property. The property value will include a <code>oslc:dialogURI</code>
      property that indicates the URI of the creation dialog.</p>

  <p>Regardless of how the response from the UI Provider is conveyed to the UI
      Consumer, the response <em>SHOULD</em> be formatted as defined by
      <code>oslc:results</code></p>

<pre class="example" id="oslcResultsCreation">
{
    "oslc:results": [
        {
            "oslc:label": "Bug 123: Server crash",
            "rdf:resource": "http://example.com/bug123"
        },
        {
            "oslc:label": "Bug 456: Client hangs on startup",
            "rdf:resource": "http://example.com/bug456"
        }
    ]
}
</pre>

  <h3>Prefilling Creation Dialogs</h3>

  <p>Service providers <em>MAY</em> support receiving a POST request whose
      content body is a resource representation to the Creation Dialog URI to
      retrieve a URI that represents the embedded page to be used. Service
      providers <em>MUST</em> respond with a response status of 201 (Created)
      with the response header <code>Location</code> whose value is the URI to
      request the newly created form. After some elapsed time, service
      providers <em>MAY</em> respond with a 404 (Not Found), 410 (Gone) or 3xx
      (Redirect) to an HTTP GET request for these URIs.</p>

  <h3>Dialog Resizing</h3>

  <p>Delegated UI dialogs receive their initial size (dimensions) based on the
      <code>oslc:hintWidth</code> and <code>oslc:hintHeight</code> properties
      described in <code>oslc:Dialog</code> resource description. There are
      cases where UI Provider recognizes that the initial size of a Delegated
      UI dialog is not sufficient and needs a way to ask the UI Consumer to
      resize the dialog. In this section we specify a mechanism that enables
      dialog resizing, but only when Post Message Protocol is used.</p>

  <p>Consumers <em>MAY</em> honor a dialog's ability to dynamically resize.
      Those that do (a) <em>MUST</em> use Post Message Protocol, (b)
      <em>MUST</em> use the <code>oslc:resize</code> value instead of any
      static width or height, and and (c) <em>MUST</em> register a handler to
      receive dialog resize messages sent by the dialog Provider and adjust the
      size of the dialog accordingly.</p>

  <p>Since a dialog is allowed to resize itself any number of times, the
      Consumer <em>MUST</em> keep a handler registered and react appropriately
      each time it received a dialog resize message from that dialog.</p>

  <p>UI Providers <em>SHOULD NOT</em> request sizes larger than 95% of the
      current viewport [[CSS2]], to avoid covering the entire viewport with the
      dialog.</p>

  <p>Here are the responsibilities of the UI Consumer and UI Provider in dialog
      resizing.</p>

  <h3>The UI Consumer's responsibilities</h3>

  <ol>
    <li>Include the Delegated UI Dialog via iframe (i.e setting iframe src to
        the URI of the Delegated UI Dialog) or via an embedded browser.</li>

    <li>Add a <code>'message'</code> listener to the outer window to receive
        messages from the Delegated UI Dialog.</li>

    <li>Listen for window <code>'message'</code> events, ignoring events from
        other sources or not prefixed with <code>"oslc-resize:"</code>.
        Multiple resize <code>'message'</code> events may be sent while the
        dialog is visible.</li>

    <li>When message from Delegated UI Dialog indicates user completed action,
        free resources and handle action.</li>
  </ol>

  <p>The UI Provider's responsibilities</p>

  <ol>
    <li>Provide Delegated UI Dialog, an HTML page that provides a user
        interface for resource creation or selection.</li>

    <li>Allow the user to perform resource creation or selection.</li>

    <li>Once the Provider needs to resize the dialog, send notification using
        <code>postMessage()</code> to the page's parent window, passed in
        <code>event.data</code> string, that is prefixed with
        <code>"oslc-resize:"</code>.  Multiple resize messages may be sent. See
        below for the response format.</li>

    <li>If the page is not parented, then the message is posted to the page's
        own window.  The page must ignore this message to itself.</li>
  </ol>

  <p>The below JavaScript code example shows how a UI Provider page would send
      a response using <code>postMessage()</code> and taking into account the
      fact that some pages are not parented.</p>

<pre class="example" id="requestResize">
function respondWithPostMessage(/*string*/ resize_response) {
    (window.parent || window).postMessage("oslc-resize:" + resize_response, "*");
}
</pre>

  <p>Regardless of how the response from the UI Provider is conveyed to the UI
      Consumer, the response <em>SHOULD</em> be formatted as follows:</p>

  <table>
      <thead>
          <tr>
              <th>JSON Property Name</th>
              <th>Type</th>
              <th>Occurs</th>
              <th>Description</th>
          </tr>
      </thead>

      <tbody>
          <tr>
              <td><code>oslc:hintHeight</code></td>
              <td>String</td>
              <td>zero-or-one</td>
              <td>Preferred height of the preview. Values <strong>MUST</strong>
                  be expressed using Cascading Style Sheet Level 2 length units
                  [[!CSS2]].</td>
          </tr>
          <tr>
              <td><code>oslc:hintWidth</code></td>
              <td>String</td>
              <td>zero-or-one</td>
              <td>Preferred width of the preview. Values <strong>MUST</strong>
                  be expressed using Cascading Style Sheet Level 2
                  length units [[!CSS2]].</td>
          </tr>
      </tbody>
  </table>

  <p>An example Dialog Resize response with new height of '600px' and a width
      of '400px':</p>

<pre class="example" id="oslcResizeMessage">
{
    "oslc:hintHeight": "600px",
    "oslc:hintWidth": "400px"
}
</pre>

<section class="appendix informative" id="history">
<h2>Change History</h2>
<p>Below is a summary of some of the changes in this draft</p>

<ul>
    <li>2014-08-28 Add Change History and References. (SP)</li>
    <li>2014-08-27 Initial draft, contributed from open-services.net. (SP)</li>
</ul>
</section>

</body>
</html>

